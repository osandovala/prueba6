<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Documentación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .table-responsive {
            margin-top: 20px;
        }
        .highlight-expired {
            background-color: #ffdddd;
        }
        .highlight-warning {
            background-color: #fff3cd;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .connection-good {
            background-color: #d4edda;
            color: #155724;
        }
        .connection-bad {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status" style="display: none;"></div>
    
    <div class="container">
        <h1 class="mb-4">Gestión de Documentación</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Nuevo Registro</h5>
                    </div>
                    <div class="card-body">
                        <form id="documentacionForm">
                            <div class="form-group">
                                <label for="cto" class="form-label">CTO*</label>
                                <input type="text" class="form-control" id="cto" required>
                            </div>
                            <div class="form-group">
                                <label for="modelo" class="form-label">Modelo</label>
                                <input type="text" class="form-control" id="modelo">
                            </div>
                            <div class="form-group">
                                <label for="patente" class="form-label">Patente</label>
                                <input type="text" class="form-control" id="patente">
                            </div>
                            <div class="form-group">
                                <label for="fecha_vencimiento_permiso_circulacion" class="form-label">Vencimiento Permiso Circulación</label>
                                <input type="date" class="form-control" id="fecha_vencimiento_permiso_circulacion">
                            </div>
                            <div class="form-group">
                                <label for="seguro_vencimiento" class="form-label">Vencimiento Seguro</label>
                                <input type="date" class="form-control" id="seguro_vencimiento">
                            </div>
                            <div class="form-group">
                                <label for="revision_tecnica_vencimiento" class="form-label">Vencimiento Revisión Técnica</label>
                                <input type="date" class="form-control" id="revision_tecnica_vencimiento">
                            </div>
                            <div class="form-group">
                                <label for="certificado_operatividad_vencimiento" class="form-label">Vencimiento Certificado Operatividad</label>
                                <input type="date" class="form-control" id="certificado_operatividad_vencimiento">
                            </div>
                            <div class="form-group">
                                <label for="sistema_supresion_vencimiento" class="form-label">Vencimiento Sistema Supresión</label>
                                <input type="date" class="form-control" id="sistema_supresion_vencimiento">
                            </div>
                            <div class="form-group">
                                <label for="seguro_terceros_vencimiento" class="form-label">Vencimiento Seguro Terceros</label>
                                <input type="date" class="form-control" id="seguro_terceros_vencimiento">
                            </div>
                            <div class="form-group">
                                <label for="decreto_80_vencimiento" class="form-label">Vencimiento Decreto 80</label>
                                <input type="date" class="form-control" id="decreto_80_vencimiento">
                            </div>
                            <input type="hidden" id="id">
                            <button type="submit" class="btn btn-primary" id="saveButton">
                                Guardar <span id="saveSpinner" class="loading" style="display: none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelEdit" style="display: none;">Cancelar</button>
                            <div id="formMessage" class="mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Búsqueda y Filtros</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="searchCto" class="form-label">Buscar por CTO</label>
                            <input type="text" class="form-control" id="searchCto" placeholder="Ingrese CTO">
                        </div>
                        <div class="form-group">
                            <label for="searchPatente" class="form-label">Buscar por Patente</label>
                            <input type="text" class="form-control" id="searchPatente" placeholder="Ingrese patente">
                        </div>
                        <div class="form-group">
                            <label for="filterExpired" class="form-label">Filtrar por vencimiento</label>
                            <select class="form-select" id="filterExpired">
                                <option value="all">Todos</option>
                                <option value="expired">Vencidos</option>
                                <option value="expiring">Por vencer (30 días)</option>
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" id="searchButton">
                            Buscar <span id="searchSpinner" class="loading" style="display: none;"></span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="resetSearch">Limpiar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>CTO</th>
                        <th>Modelo</th>
                        <th>Patente</th>
                        <th>Permiso Circulación</th>
                        <th>Seguro</th>
                        <th>Revisión Técnica</th>
                        <th>Cert. Operatividad</th>
                        <th>Sistema Supresión</th>
                        <th>Seguro Terceros</th>
                        <th>Decreto 80</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="documentacionTableBody">
                    <tr>
                        <td colspan="11" class="text-center">Cargando datos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cargar Supabase JS correctamente -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://cswjdvjlfztewtmkrxsh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzd2pkdmpsZnp0ZXd0bWtyeHNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2NDg0ODEsImV4cCI6MjA2NzIyNDQ4MX0.z0C2PtfkvYwIYfFjnFmdRicn_Jfqyq_SbCHKycHBX-4';
        
        // Variables globales
        let supabase;
        let currentEditId = null;
        let isConnected = false;

        // Función para verificar la conexión con Supabase
        async function checkSupabaseConnection() {
            const statusElement = document.getElementById('connectionStatus');
            
            try {
                // Intenta una operación simple para verificar la conexión
                const { error } = await supabase
                    .from('documentacion')
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                
                isConnected = true;
                statusElement.textContent = 'Conectado a Supabase';
                statusElement.className = 'connection-status connection-good';
                statusElement.style.display = 'block';
                console.log('Conexión con Supabase verificada correctamente');
            } catch (error) {
                isConnected = false;
                statusElement.textContent = 'Error de conexión con Supabase';
                statusElement.className = 'connection-status connection-bad';
                statusElement.style.display = 'block';
                console.error('Error verificando conexión con Supabase:', error);
                
                // Mostrar mensaje de error más detallado
                showMessage('Error de conexión con la base de datos. Por favor verifica tu conexión a internet e intenta recargar la página.', 'danger');
            }
        }

        // Función para mostrar mensajes en el formulario
        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('formMessage');
            messageDiv.innerHTML = message;
            messageDiv.className = `mt-2 alert alert-${type}`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
                messageDiv.className = 'mt-2';
            }, type === 'danger' ? 10000 : 5000);
        }

        // Función para cargar todos los registros
        async function loadDocumentacion(searchParams = {}) {
            const tableBody = document.getElementById('documentacionTableBody');
            const searchSpinner = document.getElementById('searchSpinner');
            
            try {
                // Verificar conexión antes de continuar
                if (!isConnected) {
                    await checkSupabaseConnection();
                    if (!isConnected) {
                        tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error de conexión con la base de datos</td></tr>';
                        return;
                    }
                }
                
                searchSpinner.style.display = 'inline-block';
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center">Cargando datos...</td></tr>';
                
                let query = supabase.from('documentacion').select('*');
                
                // Aplicar filtros de búsqueda
                if (searchParams.cto) {
                    query = query.ilike('cto', `%${searchParams.cto}%`);
                }
                
                if (searchParams.patente) {
                    query = query.ilike('patente', `%${searchParams.patente}%`);
                }
                
                // Aplicar filtro de vencimiento
                if (searchParams.filterExpired === 'expired') {
                    const today = new Date().toISOString().split('T')[0];
                    query = query.or(
                        `fecha_vencimiento_permiso_circulacion.lte.${today},seguro_vencimiento.lte.${today},revision_tecnica_vencimiento.lte.${today},certificado_operatividad_vencimiento.lte.${today},sistema_supresion_vencimiento.lte.${today},seguro_terceros_vencimiento.lte.${today},decreto_80_vencimiento.lte.${today}`
                    );
                } else if (searchParams.filterExpired === 'expiring') {
                    const today = new Date();
                    const in30Days = new Date(today);
                    in30Days.setDate(today.getDate() + 30);
                    const in30DaysStr = in30Days.toISOString().split('T')[0];
                    const todayStr = today.toISOString().split('T')[0];
                    
                    query = query.or(
                        `fecha_vencimiento_permiso_circulacion.gte.${todayStr},fecha_vencimiento_permiso_circulacion.lte.${in30DaysStr},` +
                        `seguro_vencimiento.gte.${todayStr},seguro_vencimiento.lte.${in30DaysStr},` +
                        `revision_tecnica_vencimiento.gte.${todayStr},revision_tecnica_vencimiento.lte.${in30DaysStr},` +
                        `certificado_operatividad_vencimiento.gte.${todayStr},certificado_operatividad_vencimiento.lte.${in30DaysStr},` +
                        `sistema_supresion_vencimiento.gte.${todayStr},sistema_supresion_vencimiento.lte.${in30DaysStr},` +
                        `seguro_terceros_vencimiento.gte.${todayStr},seguro_terceros_vencimiento.lte.${in30DaysStr},` +
                        `decreto_80_vencimiento.gte.${todayStr},decreto_80_vencimiento.lte.${in30DaysStr}`
                    );
                }
                
                const { data, error } = await query.order('cto', { ascending: true });
                
                if (error) throw error;
                
                displayDocumentacion(data);
            } catch (error) {
                console.error('Error al cargar documentación:', error);
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Error al cargar los datos: ' + error.message + '</td></tr>';
            } finally {
                searchSpinner.style.display = 'none';
            }
        }

        // Función para mostrar los registros en la tabla
        function displayDocumentacion(documentacion) {
            const tableBody = document.getElementById('documentacionTableBody');
            tableBody.innerHTML = '';
            
            if (documentacion.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center">No se encontraron registros</td></tr>';
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            documentacion.forEach(doc => {
                const row = document.createElement('tr');
                
                // Resaltar filas con documentos vencidos o por vencer
                const isExpired = [
                    doc.fecha_vencimiento_permiso_circulacion,
                    doc.seguro_vencimiento,
                    doc.revision_tecnica_vencimiento,
                    doc.certificado_operatividad_vencimiento,
                    doc.sistema_supresion_vencimiento,
                    doc.seguro_terceros_vencimiento,
                    doc.decreto_80_vencimiento
                ].some(dateStr => {
                    if (!dateStr) return false;
                    const date = new Date(dateStr);
                    return date < today;
                });
                
                const isExpiring = [
                    doc.fecha_vencimiento_permiso_circulacion,
                    doc.seguro_vencimiento,
                    doc.revision_tecnica_vencimiento,
                    doc.certificado_operatividad_vencimiento,
                    doc.sistema_supresion_vencimiento,
                    doc.seguro_terceros_vencimiento,
                    doc.decreto_80_vencimiento
                ].some(dateStr => {
                    if (!dateStr) return false;
                    const date = new Date(dateStr);
                    const in30Days = new Date(today);
                    in30Days.setDate(today.getDate() + 30);
                    return date >= today && date <= in30Days;
                });
                
                if (isExpired) {
                    row.classList.add('highlight-expired');
                } else if (isExpiring) {
                    row.classList.add('highlight-warning');
                }
                
                // Función auxiliar para formatear fechas con resaltado si está vencido
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    
                    const date = new Date(dateStr);
                    const formattedDate = date.toLocaleDateString('es-CL');
                    
                    if (date < today) {
                        return `<span class="text-danger">${formattedDate}</span>`;
                    } else if (date <= new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000)) {
                        return `<span class="text-warning">${formattedDate}</span>`;
                    }
                    return formattedDate;
                };
                
                row.innerHTML = `
                    <td>${doc.cto}</td>
                    <td>${doc.modelo || ''}</td>
                    <td>${doc.patente || ''}</td>
                    <td>${formatDate(doc.fecha_vencimiento_permiso_circulacion)}</td>
                    <td>${formatDate(doc.seguro_vencimiento)}</td>
                    <td>${formatDate(doc.revision_tecnica_vencimiento)}</td>
                    <td>${formatDate(doc.certificado_operatividad_vencimiento)}</td>
                    <td>${formatDate(doc.sistema_supresion_vencimiento)}</td>
                    <td>${formatDate(doc.seguro_terceros_vencimiento)}</td>
                    <td>${formatDate(doc.decreto_80_vencimiento)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-id="${doc.id}">Editar</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${doc.id}">Eliminar</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Agregar event listeners a los botones de editar y eliminar
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editDocumentacion(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteDocumentacion(btn.dataset.id));
            });
        }

        // Función para guardar un nuevo registro o actualizar uno existente
        async function saveDocumentacion(event) {
            event.preventDefault();
            
            const saveButton = document.getElementById('saveButton');
            const saveSpinner = document.getElementById('saveSpinner');
            const cto = document.getElementById('cto').value.trim();
            
            // Verificar conexión antes de continuar
            if (!isConnected) {
                await checkSupabaseConnection();
                if (!isConnected) {
                    showMessage('No se pudo conectar con la base de datos. Por favor verifica tu conexión a internet e intenta recargar la página.', 'danger');
                    return;
                }
            }
            
            // Validación básica
            if (!cto) {
                showMessage('El campo CTO es obligatorio', 'danger');
                return;
            }
            
            const formData = {
                cto: cto,
                modelo: document.getElementById('modelo').value.trim() || null,
                patente: document.getElementById('patente').value.trim() || null,
                fecha_vencimiento_permiso_circulacion: document.getElementById('fecha_vencimiento_permiso_circulacion').value || null,
                seguro_vencimiento: document.getElementById('seguro_vencimiento').value || null,
                revision_tecnica_vencimiento: document.getElementById('revision_tecnica_vencimiento').value || null,
                certificado_operatividad_vencimiento: document.getElementById('certificado_operatividad_vencimiento').value || null,
                sistema_supresion_vencimiento: document.getElementById('sistema_supresion_vencimiento').value || null,
                seguro_terceros_vencimiento: document.getElementById('seguro_terceros_vencimiento').value || null,
                decreto_80_vencimiento: document.getElementById('decreto_80_vencimiento').value || null
            };
            
            try {
                saveButton.disabled = true;
                saveSpinner.style.display = 'inline-block';
                
                if (currentEditId) {
                    // Actualizar registro existente
                    const { data, error } = await supabase
                        .from('documentacion')
                        .update(formData)
                        .eq('id', currentEditId)
                        .select();
                    
                    if (error) throw error;
                    
                    showMessage('Registro actualizado correctamente', 'success');
                } else {
                    // Crear nuevo registro
                    const { data, error } = await supabase
                        .from('documentacion')
                        .insert([formData])
                        .select();
                    
                    if (error) throw error;
                    
                    showMessage('Registro creado correctamente', 'success');
                }
                
                // Limpiar formulario y recargar datos
                resetForm();
                loadDocumentacion();
            } catch (error) {
                console.error('Error al guardar documentación:', error);
                showMessage('Error al guardar los datos: ' + error.message, 'danger');
            } finally {
                saveButton.disabled = false;
                saveSpinner.style.display = 'none';
            }
        }

        // Función para editar un registro
        async function editDocumentacion(id) {
            try {
                // Verificar conexión antes de continuar
                if (!isConnected) {
                    await checkSupabaseConnection();
                    if (!isConnected) {
                        showMessage('No se pudo conectar con la base de datos. Por favor verifica tu conexión a internet e intenta recargar la página.', 'danger');
                        return;
                    }
                }
                
                const { data, error } = await supabase
                    .from('documentacion')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Llenar el formulario con los datos del registro
                document.getElementById('id').value = data.id;
                document.getElementById('cto').value = data.cto;
                document.getElementById('modelo').value = data.modelo || '';
                document.getElementById('patente').value = data.patente || '';
                document.getElementById('fecha_vencimiento_permiso_circulacion').value = data.fecha_vencimiento_permiso_circulacion || '';
                document.getElementById('seguro_vencimiento').value = data.seguro_vencimiento || '';
                document.getElementById('revision_tecnica_vencimiento').value = data.revision_tecnica_vencimiento || '';
                document.getElementById('certificado_operatividad_vencimiento').value = data.certificado_operatividad_vencimiento || '';
                document.getElementById('sistema_supresion_vencimiento').value = data.sistema_supresion_vencimiento || '';
                document.getElementById('seguro_terceros_vencimiento').value = data.seguro_terceros_vencimiento || '';
                document.getElementById('decreto_80_vencimiento').value = data.decreto_80_vencimiento || '';
                
                currentEditId = data.id;
                document.getElementById('cancelEdit').style.display = 'inline-block';
                document.getElementById('cto').focus();
                
                showMessage('Editando registro ' + data.cto, 'info');
            } catch (error) {
                console.error('Error al cargar registro para edición:', error);
                showMessage('Error al cargar el registro: ' + error.message, 'danger');
            }
        }

        // Función para eliminar un registro
        async function deleteDocumentacion(id) {
            if (!confirm('¿Está seguro de que desea eliminar este registro?')) return;
            
            try {
                // Verificar conexión antes de continuar
                if (!isConnected) {
                    await checkSupabaseConnection();
                    if (!isConnected) {
                        showMessage('No se pudo conectar con la base de datos. Por favor verifica tu conexión a internet e intenta recargar la página.', 'danger');
                        return;
                    }
                }
                
                const { error } = await supabase
                    .from('documentacion')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showMessage('Registro eliminado correctamente', 'success');
                loadDocumentacion();
            } catch (error) {
                console.error('Error al eliminar documentación:', error);
                showMessage('Error al eliminar el registro: ' + error.message, 'danger');
            }
        }

        // Función para limpiar el formulario
        function resetForm() {
            document.getElementById('documentacionForm').reset();
            document.getElementById('id').value = '';
            currentEditId = null;
            document.getElementById('cancelEdit').style.display = 'none';
        }

        // Función para buscar registros
        function searchDocumentacion() {
            const searchParams = {
                cto: document.getElementById('searchCto').value.trim(),
                patente: document.getElementById('searchPatente').value.trim(),
                filterExpired: document.getElementById('filterExpired').value
            };
            
            loadDocumentacion(searchParams);
        }

        // Inicializar la aplicación
        async function initApp() {
            try {
                // Inicializar Supabase
                supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase inicializado');
                
                // Verificar conexión
                await checkSupabaseConnection();
                
                // Cargar datos iniciales
                if (isConnected) {
                    loadDocumentacion();
                }
                
                // Configurar event listeners
                document.getElementById('documentacionForm').addEventListener('submit', saveDocumentacion);
                document.getElementById('cancelEdit').addEventListener('click', resetForm);
                document.getElementById('searchButton').addEventListener('click', searchDocumentacion);
                document.getElementById('resetSearch').addEventListener('click', () => {
                    document.getElementById('searchCto').value = '';
                    document.getElementById('searchPatente').value = '';
                    document.getElementById('filterExpired').value = 'all';
                    loadDocumentacion();
                });
                
            } catch (error) {
                console.error('Error al inicializar la aplicación:', error);
                showMessage('Error al inicializar la aplicación: ' + error.message, 'danger');
            }
        }

        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
